#!/bin/bash

LOGFILE="/var/log/auth.log"
THRESHOLD=5
WINDOW_MINUTES=5

echo "Running SSH compromise detection..."

# Get current time in seconds
CURRENT_TIME=$(date +%s)

# Extract failed attempts in last 5 minutes
FAILED_IPS=$(sudo grep -a "Failed password" $LOGFILE | while read line; do
    LOG_TIME=$(echo "$line" | awk '{print $1}')
    LOG_SECONDS=$(date -d "$LOG_TIME" +%s 2>/dev/null)
    if [ ! -z "$LOG_SECONDS" ]; then
        DIFF=$(( (CURRENT_TIME - LOG_SECONDS) / 60 ))
        if [ "$DIFF" -le "$WINDOW_MINUTES" ]; then
            echo "$line"
        fi
    fi
done | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | sort | uniq -c)

# Process each IP
echo "$FAILED_IPS" | while read count ip; do
    if [ "$count" -gt "$THRESHOLD" ]; then
        
        # Check for successful login from same IP
        SUCCESS=$(sudo grep -a "Accepted password" $LOGFILE | grep "$ip")
        
        if [ ! -z "$SUCCESS" ]; then
            echo "$(date) CRITICAL: SSH brute-force succeeded from $ip ($count failed attempts)" >> ssh_security_alerts.log
            echo "CRITICAL: SSH brute-force succeeded from $ip"
        else
            echo "$(date) WARNING: SSH brute-force detected from $ip ($count failed attempts)" >> ssh_security_alerts.log
            echo "WARNING: SSH brute-force detected from $ip"
        fi
    fi
done
